BEGIN:VCALENDAR
VERSION:2.0
PRODID:{{.Title}}
NAME:{{.Title}}
UID:{{.Permalink}}
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VTIMEZONE
TZID:Europe/Warsaw
X-LIC-LOCATION:Europe/Warsaw
BEGIN:DAYLIGHT
TZOFFSETFROM:+0100
TZOFFSETTO:+0200
TZNAME:CEST
DTSTART:19700329T020000
RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU
END:DAYLIGHT
BEGIN:STANDARD
TZOFFSETFROM:+0200
TZOFFSETTO:+0100
TZNAME:CET
DTSTART:19701025T030000
RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU
END:STANDARD
END:VTIMEZONE
{{ $allPages := where (where .Site.AllPages "Type" "==" $.Page.Type) "Kind" "page" }}
{{ $s := newScratch }}
{{range $allPages}}
{{if .Params.eventDates -}}
  {{$page := .}}
  {{range (partial "getEventsFromEventDates" (dict "timezone" "Europe/Warsaw" "eventDates" .Params.eventDates)) }}
    {{$event := (merge . (dict "title" $page.Title "permalink" $page.Permalink "Params" $page.Params "Summary" $page.Summary "Language" $page.Language))}}
    {{$s.SetInMap "events" (string $event.startDateTime) (slice $event)}}
    {{end}}
  {{end}}
{{end}}
{{ range first 10 ($s.GetSortedMapValues "events") }}
{{ range . }}
{{if .Params.eventDates -}}
{{- $events := partial "getEventsFromEventDates" (dict "timezone" "Europe/Warsaw" "eventDates" .Params.eventDates) }}
{{range $events}}
BEGIN:VEVENT
{{ with $.Params.organizer}}ORGANIZER;CN="{{ .name }}":mailto:{{ .email }}{{ end }}
SUMMARY:{{if .cancelled}}CANCELLED: {{end}}{{$.Title}}{{with .comment}} -- {{.}}{{end}}
UID:{{dateFormat "20060102T150405" .startDateTime}}@hs3.pl
SEQUENCE:0
STATUS:{{if .cancelled}}CANCELLED{{else}}CONFIRMED{{end}}
DTSTAMP:{{dateFormat "20060102T150405" .startDateTime}}
DTSTART:{{dateFormat "20060102T150405" .startDateTime}}
DTEND:{{dateFormat "20060102T150405" .endDateTime}}
LOCATION:TBD
URL:{{.Permalink}}
END:VEVENT
{{end}}
{{end}}

{{end}}
{{end}}

END:VCALENDAR